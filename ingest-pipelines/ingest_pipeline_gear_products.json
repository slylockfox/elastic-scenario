{
  "description": "Product catalog from Amazon data source",
  "processors": [

    {
      "set": {"field": "_source.datedebug", "value": "{{_source.details.Date First Available}}"}
    },
    {
      "set": {
        "if": "ctx.containsKey('details') && ctx.details.containsKey('Date First Available')",
        "field": "_source.created_at", 
        "value": "{{_source.details.Date First Available}}",
        "ignore_failure": true
      }
    },

    {
      "script": {
        "lang": "painless",
        "source":
        """
          ctx.typeahead_weight = 0;
          if (ctx.containsKey('title_x') && ctx.title_x.length() > 0) {
            ctx.typeahead_weight = (int) (500.0 / ctx.title_x.length());
          }
        """
      }
    },

    {
      "set": {
        "if": "ctx.containsKey('title_x') && ctx.title_x.length() > 0",
        "field": "_source.typeahead_source", 
        "value": 
        """
        {
          "input": [
            "{{_source.title_x}}"
          ],
          "weight": {{_source.typeahead_weight}}
        }
        """
      }
    },
    {
      "json": {"field": "typeahead_source", "target_field": "typeahead"}
    },
    {
      "set": {"field": "_source.typeahead_context", "value": "All"}
    },

    {
      "script": {
        "lang": "painless",
        "source":
        """
          // data source doesn't have "available" so set it randomly for demo purposes
          Random r = new Random();
          int sample = r.nextInt(6);
          if (sample == 1) {
            ctx.available = false;
          } else {
            ctx.available = true;
          }
        """
      }
    },

    {"remove": {"field": "typeahead_weight"}},
    {"remove": {"field": "typeahead_source"}}


  ]
}